/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var k=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var D=Object.getOwnPropertyNames;var C=Object.prototype.hasOwnProperty;var A=(l,t)=>{for(var e in t)k(l,e,{get:t[e],enumerable:!0})},M=(l,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of D(t))!C.call(l,s)&&s!==e&&k(l,s,{get:()=>t[s],enumerable:!(i=V(t,s))||i.enumerable});return l};var W=l=>M(k({},"__esModule",{value:!0}),l);var H={};A(H,{LIRPSuggestModal:()=>w,default:()=>P});module.exports=W(H);var c=require("obsidian");function x(l,t){let e=[];return l.forEach((i,s)=>{t(i,s)&&e.push(s)}),e}function B(l,t,e=!1){let i=!1;if(e&&t.length%2!==0&&l>=t[t.length-1])return!0;for(let s=0;s<t.length-2;s=s+2)if(t[s]<=l&&l<=t[s+1])return!0;return i}function v(l){return l.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var E=class{checkDice(t){return/^(\d+)?d(\d+)([\+\-]\d+)?(e)?(k\d+)?(kl\d+)?$/i.test(t)}rollDice(t){if(!this.checkDice(t))throw new Error("Syntaxe de lancer de d\xE9s invalide.");let[e,i,s,o,n,r,a]=t.match(/^(\d+)?d(\d+)([\+\-]\d+)?(e)?(k\d+)?(kl\d+)?$/i),h=parseInt(i||"1"),m=parseInt(s),S=parseInt(o||"0"),d=!!n,g=r?parseInt(r.slice(1)):void 0,u=a?parseInt(a.slice(2)):void 0,p=[];for(let f=0;f<h;f++){let L=Math.floor(Math.random()*m)+1;if(p.push(L),d)for(;L===m;)L=Math.floor(Math.random()*m)+1,p.push(L)}return g?(p.sort((f,L)=>L-f),p=p.slice(0,g)):u&&(p.sort((f,L)=>f-L),p=p.slice(0,u)),p.reduce((f,L)=>f+L,0)+S}replaceDiceRolls(t,e,i){let s=new RegExp(`${this.escapeRegExp(e)}([^${this.escapeRegExp(e+i)}]+)${this.escapeRegExp(i)}`,"g");return t.replace(s,(o,n)=>{try{return this.rollDice(n).toString()}catch(r){return o}})}escapeRegExp(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}},O=["dupInNote","dupInFolder","emptyList","emptyNote","refLimit","subRefLimit","pathSetting","folderAndFile","showItem","noActiveView"],T=class l{static getErrorStatus(){return["dupInFolder","pathSetting"]}static getWarningStatus(){let t=[];return O.map(e=>{!l.getErrorStatus().contains(e)&&!l.getWarningStatus().contains(e)&&t.push(e)}),t}static getInfoStatus(){return["showItem","refLimit","subRefLimit"]}getType(){return["pathSetting","dupInFolder"].contains(this.status)?"error":"warning"}constructor(t,e,i,s=""){this.father=t,this.child=e,this.status=i,this.complement=s}toString(){return`${this.getType()} / ${this.father} / ${this.child} / ${this.status} / ${this.complement}`}},R=class{constructor(){this.logs=[]}push(t,e,i,s=""){this.logs.push(new T(t,e,i,s))}add(t){this.logs=this.logs.concat(t.logs)}get(t){let e=this.logs.filter(s=>s.getType()===t),i=[];return e.map(s=>{i.push(s.toString())}),i}flush(){this.logs=[]}},N=class l{static getSettingString(t=""){if(t==="")return`- [ ] Hide this list
`;switch(t){case"hide":return"^- \\[[x \\?]\\] Hide this list$";case"hide_string":return"- \\[[x ?]\\] Hide this list";case"hide_ticked":return"^- \\[[x?]\\] Hide this list$"}}constructor(t,e,i,s,o){this.title="",this.description="",this.hidden=!1,this.items=[],this.logs=new R,this.nullValue=i,this.escapeString=s,this.commentString=o;let n=/^# +(.+)$/;this.title=e[0].replace(n,"$1"),e.shift();let r=`^(?!${l.getSettingString("hide_string")}) {0,3}(-|\\d+.|\\*) +(.+)$`,a=new RegExp(r),h=x(e,g=>a.test(g));if(h.length===0){this.logs.push(t,this.title,"emptyList"),this.hidden=!0;return}let m=e.map(g=>g.replace(a,"$2"));if(h[0]!==0){let g=m.slice(0,h[0]);g[0]===""&&g.shift();let u=!1,p=new RegExp(l.getSettingString("hide_ticked")),$=new RegExp(l.getSettingString("hide"));g.map(f=>{p.test(f)&&(u=!0,this.hidden=u)}),g=g.filter(f=>!$.test(f)),this.description=g.join(`
`)}else this.description="";let S=h.length,d;for(let g=0;g<S-1;g++)d=m.slice(h[g],h[g+1]),this.pushItemBasedOnWeight(d);d=m.slice(h[S-1]),d.at(-1)===""&&d.pop(),this.pushItemBasedOnWeight(d)}flushLogs(){this.logs.flush()}pushItemBasedOnWeight(t){let e=/^\((\d+)\)\s+(.+)$/,i,s;(i=e.exec(t[0]))!==null?(s=Number(i[1]),t[0]=i[2]):s=1,t[0]===this.nullValue&&(t.length===1?t[0]="":t.shift());let o=`^ *${this.escapeString}(.*)`,n=new RegExp(o,"gm"),a=t.map(h=>h.replace(n,"$1")).join(`
`);for(let h=0;h<s;h++)this.items.push(a)}getSuggestion(t){return{noteName:t,title:this.title,description:this.description.split(`
`)[0]}}notHidden(){return!this.hidden}pickRandomItem(){let t="";return this.items.length>0&&(t=this.items[Math.floor(Math.random()*this.items.length)]),t}getLogs(){return this.logs}get length(){return this.items.length}},I=class l{static getSettingString(t=""){if(t==="")return`- [ ] Do not preserve comments
`;switch(t){case"deleteComment":return"^- \\[[x ?]\\] Do not preserve comments$";case"deleteComment_ticked":return"^- \\[[x?]\\] Do not preserve comments$"}}constructor(t,e,i,s){this.noteName="",this.description="",this.list=[],this.logs=new R,this.nullValue=t,this.escapeString=e,this.commentString=i,this.rollDice=!0,this.referenceMaxDepth=s,this.keepComment=!0}getListTitles(){let t=[];return this.list.map(e=>{t.push(e.title)}),t}workWithComment(t){let e=new RegExp(l.getSettingString("deleteComment_ticked")),i=/^# .+$/,s=`^${this.commentString}$`,o=new RegExp(s),n=`${this.commentString}.*?${this.commentString}`,r=new RegExp(n),a=t.split(`
`),h=x(a,u=>e.test(u)),m=x(a,u=>o.test(u)),S=x(a,u=>i.test(u));if(S.length===0)return t;h.length===0||h[0]>S[0]?this.keepComment=!0:this.keepComment=B(h[0],m);let d=!1,g=[];return a.map(u=>{let p=!1;o.test(u)&&(d=!d,p=!0),d||p?this.keepComment&&g.push(this.escapeString+u):this.keepComment?g.push(u):g.push(u.replace(r,""))}),g.join(`
`)}loadFromNote(t,e){this.noteName=t;let i=[];i=this.workWithComment(e).split(`
`),i[0]===""&&i.shift();let s=/^# .+$/,o=x(i,a=>s.test(a));if(o.length===0)return this.logs.push(t,"","emptyNote"),!1;if(o[0]!==0){let a=i.slice(0,o[0]),h=new RegExp(l.getSettingString("deleteComment"));a=a.filter(m=>!h.test(m)),this.description=a.join(`
`)}let n=o.length,r=!0;for(let a=0;a<n-1;a++)r=this.pushListIfNotExists(new N(this.noteName,i.slice(o[a],o[a+1]),this.nullValue,this.escapeString,this.commentString))&&r;return r=this.pushListIfNotExists(new N(this.noteName,i.slice(o[n-1]),this.nullValue,this.escapeString,this.commentString))&&r,r}pushListIfNotExists(t){return this.getListTitles().contains(t.title)?(this.logs.push(this.noteName,t.title,"dupInNote"),!1):(this.list.push(t),!0)}getListSuggestion(t=!1){let e=new b;return this.list.forEach(i=>{(t||i.notHidden())&&e.push(i.getSuggestion(this.noteName))}),e}doReferenceSubstitution(t){let e,i=t,s="",o=`{(${this.list.map(n=>v(n.title)).join("|")})}`;for(let n=0;n<this.referenceMaxDepth;n++){let r=new RegExp(o,"mg");for(;(e=r.exec(i))!==null;){let a=this.pickRandomItemFromList(e[1],!1);s=e[0],i=i.replace(s,a),r.lastIndex=e.index+a.length}}return this.rollDice&&(i=new E().replaceDiceRolls(i,"{","}")),{lastListTitle:s,modifiedText:i}}flushLogs(){this.logs.flush(),this.list.map(t=>{t.flushLogs()})}pickRandomItemFromList(t,e=!0){let i="",s={lastListTitle:t,modifiedText:""},o=this.list.find(n=>n.title===t);if(o!==void 0){if(i=o.pickRandomItem(),e){s=this.doReferenceSubstitution(i),i=s.modifiedText;let n=`{(${this.list.map(a=>v(a.title)).join("|")})}`;new RegExp(n).test(i)&&e&&(s.lastListTitle===""&&(s.lastListTitle=t),this.logs.push(this.noteName,s.lastListTitle,"refLimit"))}return i}else return""}getLogs(){let t=new R;return t.add(this.logs),this.list.map(e=>{t.add(e.getLogs())}),t}get length(){return this.list.length}},F=class{constructor(t,e,i,s){this.multiNote=[],this.nullValue=t,this.escapeString=e,this.commentString=i,this.referenceMaxDepth=s,this.logs=new R}loadFromNote(t,e){let i=new I(this.nullValue,this.escapeString,this.commentString,this.referenceMaxDepth),s=i.loadFromNote(t,e);return s=this.pushNoteIfListNotExists(i)&&s,s}pushNoteIfListNotExists(t){let e=this.getListTitles(),i=!0;return t.getListTitles().map(s=>{e.contains(s)&&(this.logs.push(t.noteName,s,"dupInFolder",this.getNoteNameFromListTitle(s)),i=!1)}),i?this.multiNote.push(t):this.logs.add(t.logs),i}getNoteNameFromListTitle(t){let e=this.multiNote.find(i=>i.getListTitles().contains(t));return e!==void 0?e.noteName:""}getListTitles(){let t=[];return this.multiNote.map(e=>{t=t.concat(e.getListTitles())}),t}getListSuggestion(t=!1){let e=new b;return this.multiNote.map(i=>{e=e.concat(i.getListSuggestion(t))}),e}getNoteSuggestion(t=!1){let e=new b;return this.multiNote.map(i=>{i.getListSuggestion(t).length>0&&e.push({noteName:i.noteName,title:i.noteName,description:i.description.split(`
`)[0]})}),e}doReferenceSubstitution(t){let e=new I(this.nullValue,this.escapeString,this.commentString,this.referenceMaxDepth);this.multiNote.map(r=>{e.list=e.list.concat(r.list)});let i={lastListTitle:"Reference substitution in selection",modifiedText:""};i=e.doReferenceSubstitution(t);let s="",o=`{(${e.list.map(r=>v(r.title)).join("|")})}`;return new RegExp(o).test(i.modifiedText)&&this.logs.push("","","subRefLimit"),i.modifiedText}pickRandomItemFromList(t,e=!0){let i=new I(this.nullValue,this.escapeString,this.commentString,this.referenceMaxDepth);i.noteName=this.getNoteNameFromListTitle(t),this.multiNote.map(o=>{i.list=i.list.concat(o.list)});let s=i.pickRandomItemFromList(t);return this.logs.add(i.getLogs()),s}flushLogs(){this.logs.flush(),this.multiNote.map(t=>{t.flushLogs()})}getLogs(){let t=new R;return t.add(this.logs),this.multiNote.map(e=>{t.add(e.getLogs())}),t}hasErrors(){return this.getLogs().get("error").length!==0}get length(){return this.multiNote.length}},b=class l{constructor(){this.list=[]}push(t){this.list.push(t)}filterByNoteName(t){let e=new l;return this.list.map(i=>{i.noteName===t&&e.push(i)}),e}filter(t){let e=new l;for(let i=0;i<this.list.length;i++)t(this.list[i],i,this.list)&&e.push(this.list[i]);return e}concat(t){let e=new l;return e.list=this.list.concat(t.list),e}get length(){return this.list.length}},w=class extends c.SuggestModal{constructor(t,e,i){super(t),this.items=e,this.callback=i}getSuggestions(t){return this.items.filter(e=>e.title.toLowerCase().includes(t.toLowerCase())).list}renderSuggestion(t,e){e.createEl("div",{text:t.title});let i=t.description;e.createEl("small",{text:i})}onChooseSuggestion(t,e){this.callback(t)}},j={notePath:"Note or folder path",nullValue:"null",escapeValue:"//",selectionForNotification:"!",showNoteSelector:!0,showWarning:!0,deleteSelectionForNotification:!1,maxReferenceDepth:3,commentValue:"%%"},P=class extends c.Plugin{async onload(){await this.loadSettings(),this.logs=new R,this.addRibbonIcon("list-tree","Pick random list item",t=>{this.prepareAction("note")}),this.addCommand({id:"insert-random-item",name:"Insert random item from list",callback:()=>{this.prepareAction("note")}}),this.addCommand({id:"insert-list-setting-item",name:"Insert list settings values",callback:()=>{this.insertString(N.getSettingString())}}),this.addCommand({id:"insert-note-setting-item",name:"Insert note settings values",callback:()=>{this.insertString(I.getSettingString())}}),this.addCommand({id:"insert-reference-item",name:"Insert list reference",callback:()=>{this.prepareAction("reference")}}),this.addCommand({id:"replace-reference-item",name:"Replace references in selection",callback:()=>{this.prepareAction("doRefSubstitution")}}),this.addSettingTab(new y(this.app,this))}onunload(){}getLIRPFiles(t){let e=this.app.vault.getMarkdownFiles(),i=[],s=!1,o=`${t}.md`,n=new RegExp(`^${t}/.+.md$`);return e.map(r=>{n.test(r.path)?i.push(r.path):r.path===o&&(s=!0)}),i.length===0&&s?i.push(o):s&&i.length!==0&&this.logs.push("ListItemRandmPicker","getLIRPFiles","folderAndFile"),i}async loadLIRPFiles(){let t=this.getLIRPFiles(this.settings.notePath),e=new F(this.settings.nullValue,this.settings.escapeValue,this.settings.commentValue,this.settings.maxReferenceDepth);for(let i of t){let s=this.app.vault.getAbstractFileByPath(i),o="";s instanceof c.TFile&&(o=await this.app.vault.cachedRead(s),e.loadFromNote(s.path.slice(0,-3),o))}return e}async prepareAction(t){let e=await this.loadLIRPFiles();e.length===0&&this.logs.push("ListItemRandomPicker","loadLIRPFiles","pathSetting"),!e.hasErrors()&&e.length!==0&&(t==="doRefSubstitution"?this.doReferenceSubstitution(e):e.length===1||!this.settings.showNoteSelector?new w(this.app,e.getListSuggestion(t==="reference"),i=>{t==="note"?this.workWithTitle(e,i.title):this.insertString(`{${i.title}}`)}).open():new w(this.app,e.getNoteSuggestion(t==="reference"),i=>{new w(this.app,e.getListSuggestion(t==="reference").filterByNoteName(i.noteName),s=>{t==="note"?this.workWithTitle(e,s.title):this.insertString(`{${s.title}}`)}).open()}).open()),this.doLogManagement(e.getLogs()),this.logs.flush(),e.flushLogs()}doLogManagement(t){let e=this.logs;t!==void 0&&(e.add(t),t.flush());let i=[],s=[],o=[];e.logs.map(n=>{switch(n.status){case"dupInNote":s.push(`List "${n.child}" is duplicate in note "${n.father}". List is ignored`);break;case"dupInFolder":i.push(`ERROR : List "${n.child}" exists in two notes, "${n.father}" and "${n.complement}", make correction !`);break;case"emptyList":s.push(`List "${n.child}" is empty in "${n.father}"`);break;case"emptyNote":s.push(`"${n.child}" is empty`);break;case"refLimit":s.push(`Reference depth limit reach with list "${n.child}" in note "${n.father}"`);break;case"pathSetting":i.push("ERROR : verify path in plugin settings");break;case"folderAndFile":s.push("A note with the same name as the folder in settings gets ignored.");break;case"showItem":o.push(`${n.complement}`);break;case"noActiveView":s.push("No note in edition mode to do this action");break}i.map(r=>new c.Notice(r)),this.settings.showWarning&&s.map(r=>new c.Notice(r)),o.map(r=>new c.Notice(r))}),this.logs.flush()}workWithTitle(t,e){let i=this.app.workspace.getActiveViewOfType(c.MarkdownView);if(i){let s=`^${this.settings.selectionForNotification}$`,o=new RegExp(s),n=i.editor.getSelection();if(o.test(n))this.logs.push("","","showItem",t.pickRandomItemFromList(e)),this.settings.deleteSelectionForNotification&&i.editor.replaceSelection("");else{let r="",a=/^(\d+)(.*)/gm,h,m;if((h=a.exec(n))!==null){let S=Number(h[1]),d=n.replace(/^\d+/,""),g=[];for(let u=0;u<S;u++)g.push(t.pickRandomItemFromList(e));r=g.join(d)}else r=t.pickRandomItemFromList(e);i.editor.replaceSelection(r)}}else this.logs.push("ListItemRandomPicker","workWithTitle","noActiveView");this.doLogManagement(t.getLogs())}doReferenceSubstitution(t){let e=this.app.workspace.getActiveViewOfType(c.MarkdownView);if(e){let i=e.editor.getSelection();e.editor.replaceSelection(t.doReferenceSubstitution(i))}else this.logs.push("ListItemRandomPicker","workWithTitle","noActiveView")}insertString(t){let e=this.app.workspace.getActiveViewOfType(c.MarkdownView);e?e.editor.replaceSelection(t):this.logs.push("ListItemRandomPicker","workWithTitle","noActiveView"),this.doLogManagement()}async loadSettings(){this.settings=Object.assign({},j,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}},y=class extends c.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),new c.Setting(t).setName("Path").setDesc('The path of a note or folder. Example: "Folder/Note" or "Folder".').addText(e=>e.setPlaceholder("Enter the path to your note").setValue(this.plugin.settings.notePath).onChange(async i=>{this.plugin.settings.notePath=i,await this.plugin.saveSettings()})),t.createEl("h2",{text:"Specific values"}),new c.Setting(t).setName("Null value").setDesc("If the first line of a list item has this value, that line is ignored. This allows you to have probabilities of getting no result. Usage example: having, or not having, a particle in a noun.").addText(e=>e.setPlaceholder("Enter value").setValue(this.plugin.settings.nullValue).onChange(async i=>{this.plugin.settings.nullValue=i,await this.plugin.saveSettings()})),new c.Setting(t).setName("Escape value").setDesc("To include heading one elements or first-level list items in your random list, escape them with these values. Exemple : // # Heading").addText(e=>e.setPlaceholder("Enter value").setValue(this.plugin.settings.escapeValue).onChange(async i=>{this.plugin.settings.escapeValue=i,await this.plugin.saveSettings()})),new c.Setting(t).setName("Selection value for notification").setDesc("If the selected text has this value, the item is not inserted; instead, a notification is shown.").addText(e=>e.setPlaceholder("Enter value").setValue(this.plugin.settings.selectionForNotification).onChange(async i=>{this.plugin.settings.selectionForNotification=i,await this.plugin.saveSettings()})),t.createEl("h2",{text:"Behavior"}),new c.Setting(t).setName("Show note selector").setDesc("If path is a folder containing at least two notes, a selector will allow you to choose the note; otherwise, all lists will be offered to you.").addToggle(e=>{e.setValue(this.plugin.settings.showNoteSelector),e.onChange(async i=>{this.plugin.settings.showNoteSelector=i,await this.plugin.saveSettings()})}),new c.Setting(t).setName("Show warning").setDesc("Are warnings displayed as notifications ?").addToggle(e=>{e.setValue(this.plugin.settings.showWarning),e.onChange(async i=>{this.plugin.settings.showWarning=i,await this.plugin.saveSettings()})}),new c.Setting(t).setName("Delete selection value on notification").setDesc("If this setting is on, the selected notification value is removed after it's used.").addToggle(e=>{e.setValue(this.plugin.settings.deleteSelectionForNotification),e.onChange(async i=>{this.plugin.settings.deleteSelectionForNotification=i,await this.plugin.saveSettings()})}),new c.Setting(t).setName("Reference depth limit").setDesc("Reference recursion limit: the maximum number of nested reference calls allowed. Zero disables reference resolution.").addSlider(e=>e.setValue(this.plugin.settings.maxReferenceDepth).setLimits(0,10,1).setDynamicTooltip().onChange(async i=>{this.plugin.settings.maxReferenceDepth=i,await this.plugin.saveSettings()}))}};
